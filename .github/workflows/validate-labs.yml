name: Validate Labs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly to catch image/dependency issues
    - cron: '0 0 * * 0'

jobs:
  validate-ospf:
    name: OSPF Basics Lab
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Build frr-ssh image with admin/cisco credentials
        run: |
          bash ./build-frr-ssh.sh

      - name: Deploy OSPF lab
        run: |
          cd ospf-basics
          sudo containerlab deploy -t topology.clab.yml

      - name: Wait for OSPF convergence
        run: sleep 60

      - name: Test SSH access to r1 (admin/cisco)
        run: |
          echo "========================================="
          echo "SSH Access Validation (admin/cisco)"
          echo "========================================="
          echo ""
          echo "Testing SSH to r1 on port 2221..."
          sshpass -p 'cisco' ssh -o StrictHostKeyChecking=no -p 2221 admin@localhost "show version" && echo "✓ SSH access working!" || echo "✗ SSH access failed"
          echo ""

      - name: Run validation tests
        run: |
          cd ospf-basics
          chmod +x scripts/validate.sh
          sudo bash scripts/validate.sh

      - name: Cleanup
        if: always()
        run: |
          cd ospf-basics
          sudo containerlab destroy -t topology.clab.yml || true

  validate-bgp:
    name: BGP eBGP Basics Lab
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Build frr-ssh image with admin/cisco credentials
        run: |
          bash ./build-frr-ssh.sh

      - name: Deploy BGP lab
        run: |
          cd bgp-ebgp-basics
          sudo containerlab deploy -t topology.clab.yml

      - name: Wait for BGP convergence
        run: sleep 60

      - name: Test SSH access to r1 (admin/cisco)
        run: |
          echo "========================================="
          echo "SSH Access Validation (admin/cisco)"
          echo "========================================="
          echo ""
          echo "Testing SSH to r1 on port 2211..."
          sshpass -p 'cisco' ssh -o StrictHostKeyChecking=no -p 2211 admin@localhost "show version" && echo "✓ SSH access working!" || echo "✗ SSH access failed"
          echo ""

      - name: Run validation tests
        run: |
          cd bgp-ebgp-basics
          chmod +x scripts/validate.sh
          sudo bash scripts/validate.sh

      - name: Cleanup
        if: always()
        run: |
          cd bgp-ebgp-basics
          sudo containerlab destroy -t topology.clab.yml || true

  validate-netns:
    name: Linux Network Namespaces Lab
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install containerlab
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"

      - name: Pull Alpine image
        run: docker pull alpine:latest

      - name: Deploy Linux Namespaces lab
        run: |
          cd linux-network-namespaces
          sudo containerlab deploy -t topology.clab.yml

      - name: Wait for containers to be ready
        run: sleep 30

      - name: Run validation tests
        run: |
          cd linux-network-namespaces
          chmod +x scripts/validate.sh
          sudo bash scripts/validate.sh

      - name: Cleanup
        if: always()
        run: |
          cd linux-network-namespaces
          sudo containerlab destroy -t topology.clab.yml || true

  validate-vyos:
    name: VyOS Firewall Basics Lab
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install containerlab
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"

      - name: Deploy VyOS Firewall lab
        run: |
          cd vyos-firewall-basics
          sudo containerlab deploy -t topology.clab.yml

      - name: Wait for VyOS initialization
        run: sleep 60

      - name: Run validation tests
        run: |
          cd vyos-firewall-basics
          chmod +x scripts/validate.sh
          sudo bash scripts/validate.sh

      - name: Cleanup
        if: always()
        run: |
          cd vyos-firewall-basics
          sudo containerlab destroy -t topology.clab.yml || true

  validate-enterprise-vpn:
    name: Enterprise VPN Migration Lab
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install containerlab
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"

      - name: Build frr-ssh image
        run: |
          bash ./build-frr-ssh.sh

      - name: Deploy Enterprise VPN lab
        run: |
          cd enterprise-vpn-migration
          sudo containerlab deploy -t topology.clab.yml

      - name: Wait for convergence
        run: sleep 90

      - name: Run validation tests (quick mode)
        run: |
          cd enterprise-vpn-migration
          chmod +x scripts/validate.sh
          sudo bash scripts/validate.sh --quick

      - name: Cleanup
        if: always()
        run: |
          cd enterprise-vpn-migration
          sudo containerlab destroy -t topology.clab.yml --cleanup || true

  validate-zero-trust:
    name: Zero Trust Fundamentals Lab
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Zero Trust lab
        run: |
          cd zero-trust-fundamentals
          docker-compose up -d --build

      - name: Wait for services
        run: sleep 30

      - name: Run validation tests
        run: |
          cd zero-trust-fundamentals
          chmod +x scripts/validate.sh
          bash scripts/validate.sh

      - name: Cleanup
        if: always()
        run: |
          cd zero-trust-fundamentals
          docker-compose down -v || true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validate-ospf, validate-bgp, validate-netns, validate-vyos, validate-enterprise-vpn, validate-zero-trust]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "========================================="
          echo "Lab Validation Summary"
          echo "========================================="
          echo ""
          echo "OSPF Basics:           ${{ needs.validate-ospf.result }}"
          echo "BGP eBGP Basics:       ${{ needs.validate-bgp.result }}"
          echo "Linux Namespaces:      ${{ needs.validate-netns.result }}"
          echo "VyOS Firewall:         ${{ needs.validate-vyos.result }}"
          echo "Enterprise VPN:        ${{ needs.validate-enterprise-vpn.result }}"
          echo "Zero Trust:            ${{ needs.validate-zero-trust.result }}"
          echo ""

          # Fail if any job failed
          if [ "${{ needs.validate-ospf.result }}" != "success" ] || \
             [ "${{ needs.validate-bgp.result }}" != "success" ] || \
             [ "${{ needs.validate-netns.result }}" != "success" ] || \
             [ "${{ needs.validate-vyos.result }}" != "success" ] || \
             [ "${{ needs.validate-enterprise-vpn.result }}" != "success" ] || \
             [ "${{ needs.validate-zero-trust.result }}" != "success" ]; then
            echo "Some labs failed validation!"
            exit 1
          fi

          echo "All labs passed!"
